<!DOCTYPE html>
<html>

    <head>
        <title> AWS volume script &middot; Linuxian </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="generator" content="Hugo 0.13" />




<script   src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">


<link rel="stylesheet" href="http://www.linuxian.com/css/nix.css">
<link rel="stylesheet" href="http://www.linuxian.com/css/override.css">

 
<link href="https://fonts.googleapis.com/css?family=Inconsolata|Open+Sans|Roboto|Montserrat|Concert+One" rel="stylesheet">



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
				  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'your_google_analytics_id', 'auto');
	  ga('send', 'pageview');

</script>


    </head>

    <body>
        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" id="green-terminal" href=http://www.linuxian.com>rahulinux@web ~ $</a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href="http://www.linuxian.com">/home/rahulinux</a>
				</li>
				
				
				<li >
					<a href="/posts">~/posts</a>
				</li>
				
				
				<li >
					<a href="/aboute-me">~/about_me</a>
				</li>
				

			</ul>
		</div>
	</div>
</nav>
</header>

        <div class="container wrapper">
            <h1><a href="http://www.linuxian.com/posts/aws-volume-script/">AWS volume script</a></h1>
             
            <span class="post-date">May 2, 2017 </span>
            
            <div class="post-content">
                <p>Here is small useful script which will help you to attach volume on ec2 instances without login into the AWS console.</p>

<p>I&rsquo;m connected to AWS using VPN, so following script will work with private ip but if you are not connected to vpn, then you can
change PrivateIpAddress to PublicIp</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><span></span><span style="color: #75715e">#!/bin/bash</span>

<span style="color: #75715e"># Create and Attach Volume to Instace using IP Address</span>

<span style="color: #f8f8f2">AWS_ACCESS_KEY_ID</span><span style="color: #f92672">=</span>XXXX
<span style="color: #f8f8f2">AWS_SECRET_ACCESS_KEY</span><span style="color: #f92672">=</span>XXXX
<span style="color: #f8f8f2">REGION</span><span style="color: #f92672">=</span>us-east-1
<span style="color: #f8f8f2">AWS_DEFAULT_REGION</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">$REGION</span>
<span style="color: #f8f8f2">VPC</span><span style="color: #f92672">=</span>VPC_ID

<span style="color: #66d9ef">if</span> <span style="color: #f92672">[[</span> <span style="color: #f8f8f2">$#</span> -ne <span style="color: #ae81ff">1</span> <span style="color: #f92672">]]</span>
<span style="color: #66d9ef">then</span>
    <span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&quot;Usage: </span><span style="color: #f8f8f2">$0</span><span style="color: #e6db74"> &lt;hostname|IP&gt;&quot;</span>
    <span style="color: #f8f8f2">exit</span> <span style="color: #ae81ff">1</span>
<span style="color: #66d9ef">fi</span>

msg<span style="color: #f92672">(){</span>

    <span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&quot;=========={</span><span style="color: #f8f8f2">$@</span><span style="color: #e6db74">}==========&quot;</span>

<span style="color: #f92672">}</span>

get_instance_data<span style="color: #f92672">(){</span>
    <span style="color: #75715e"># returns ZONE STATUS IP INSTANCE_ID DEVICE</span>
    <span style="color: #f8f8f2">local</span> <span style="color: #f8f8f2">host</span><span style="color: #f92672">=</span><span style="color: #f8f8f2">$1</span>
    <span style="color: #66d9ef">if</span> ! <span style="color: #f8f8f2">echo</span> <span style="color: #f8f8f2">$host</span> <span style="color: #f8f8f2">|</span> grep -qE <span style="color: #e6db74">&#39;\b((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4}\b&#39;</span>
    <span style="color: #66d9ef">then</span>
         <span style="color: #f8f8f2">host</span><span style="color: #f92672">=</span><span style="color: #66d9ef">$(</span>dig +short <span style="color: #f8f8f2">$host</span><span style="color: #66d9ef">)</span>
    <span style="color: #66d9ef">fi</span>
    <span style="color: #f8f8f2">raw_data</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;</span><span style="color: #66d9ef">$(</span>aws ec2 describe-instances <span style="color: #ae81ff">\</span>
        --query <span style="color: #e6db74">&#39;Reservations[*].Instances[*].[Placement.AvailabilityZone, State.Name,PrivateIpAddress,InstanceId,BlockDeviceMappings[*].DeviceName]&#39;</span> <span style="color: #ae81ff">\</span>
        --output text <span style="color: #f8f8f2">|</span> grep -A1 <span style="color: #e6db74">&quot;${</span><span style="color: #f8f8f2">host</span><span style="color: #e6db74">}\t&quot;</span><span style="color: #66d9ef">)</span><span style="color: #e6db74">&quot;</span>
    <span style="color: #f8f8f2">instance_data</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;</span><span style="color: #66d9ef">$(</span> <span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&quot;${</span><span style="color: #f8f8f2">raw_data</span><span style="color: #e6db74">}&quot;</span> <span style="color: #f8f8f2">|</span> head -1 <span style="color: #66d9ef">)</span><span style="color: #e6db74">&quot;</span>
    <span style="color: #f8f8f2">vid</span><span style="color: #f92672">=</span><span style="color: #66d9ef">$(</span> <span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&quot;${</span><span style="color: #f8f8f2">raw_data</span><span style="color: #e6db74">}&quot;</span> <span style="color: #f8f8f2">|</span> grep -o <span style="color: #e6db74">&#39;sd.&#39;</span> <span style="color: #f8f8f2">|</span> sort <span style="color: #f8f8f2">|</span> uniq <span style="color: #f8f8f2">|</span> tail -1 <span style="color: #f8f8f2">|</span> cut -c <span style="color: #ae81ff">3</span>- <span style="color: #f8f8f2">|</span> tr <span style="color: #e6db74">&quot;0-9a-z&quot;</span> <span style="color: #e6db74">&quot;1-9a-z_&quot;</span><span style="color: #66d9ef">)</span>
    <span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&quot;${</span><span style="color: #f8f8f2">instance_data</span><span style="color: #e6db74">}&quot;</span> <span style="color: #e6db74">&quot;/dev/sd${</span><span style="color: #f8f8f2">vid</span><span style="color: #e6db74">}&quot;</span>
<span style="color: #f92672">}</span>

msg <span style="color: #e6db74">&quot;Fetching Instance Data&quot;</span>
<span style="color: #f8f8f2">read</span> ZONE STATUS IP INSTANCE_ID DEVICE <span style="color: #f92672">&lt;&lt;&lt;</span><span style="color: #e6db74">&quot;</span><span style="color: #66d9ef">$(</span>get_instance_data <span style="color: #f8f8f2">$1</span><span style="color: #66d9ef">)</span><span style="color: #e6db74">&quot;</span>
msg <span style="color: #e6db74">&quot;Done&quot;</span>

msg <span style="color: #e6db74">&quot;Creating Volume in Zone </span><span style="color: #f8f8f2">$ZONE</span><span style="color: #e6db74"> for IP </span><span style="color: #f8f8f2">$IP</span><span style="color: #e6db74"> [ID: </span><span style="color: #f8f8f2">$INSTANCE_ID</span><span style="color: #e6db74">]&quot;</span>
<span style="color: #f8f8f2">volume_id</span><span style="color: #f92672">=</span><span style="color: #e6db74">&quot;</span><span style="color: #66d9ef">$(</span>aws ec2 create-volume --size <span style="color: #ae81ff">20</span> --region <span style="color: #f8f8f2">$REGION</span> --availability-zone <span style="color: #f8f8f2">$ZONE</span> --volume-type standard <span style="color: #f8f8f2">|</span> jq -r .VolumeId<span style="color: #66d9ef">)</span><span style="color: #e6db74">&quot;</span>

msg <span style="color: #e6db74">&quot;Volume has been created with ID:</span><span style="color: #f8f8f2">$volume_id</span><span style="color: #e6db74">&quot;</span>
<span style="color: #f8f8f2">echo</span> <span style="color: #e6db74">&quot;Waiting for Volume availability&quot;</span> <span style="color: #f92672">&amp;&amp;</span> sleep <span style="color: #ae81ff">30</span>
msg <span style="color: #e6db74">&quot;Attaching to Instance&quot;</span>
aws ec2 attach-volume --volume-id <span style="color: #f8f8f2">$volume_id</span>  --instance-id <span style="color: #f8f8f2">$INSTANCE_ID</span> --device <span style="color: #f8f8f2">$DEVICE</span>
</pre></div>


            </div>
            
            <div class="post-comments">
                <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'linuxian';
    var disqus_identifier = 'http:\/\/www.linuxian.com\/posts\/aws-volume-script\/';
    var disqus_title = 'AWS volume script';
    var disqus_url = 'http:\/\/www.linuxian.com\/posts\/aws-volume-script\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
            
            <div class="push"></div>
        </div>
        <footer class="footer text-center">

<div class="text-center">Copyright Â© 2017 Rahul Patil</div>

</footer>

    </body>
