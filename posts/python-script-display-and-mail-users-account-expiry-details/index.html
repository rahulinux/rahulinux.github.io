<!DOCTYPE html>
<html>

    <head>
        <title> Send password expiry notification to nix users using Python script &middot; The Linuxian </title>

        <meta content="Send password expiry notification to nix users using Python script - The Linuxian" property="og:title">
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<meta name="keywords" content="scripting,python,password expiry,email notification">
<meta name="description" content="This is a purely technical blog concerning topics such as Linux,DevOps,Big Data,Cloud,Shell Scripting,Python and open source software. - Send password expiry notification to nix users using Python script" property="og:description">
<meta name="robots" content="index, follow">


<script   src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">


<link rel="stylesheet" href="http://www.linuxian.com/css/nix.css">
<link rel="stylesheet" href="http://www.linuxian.com/css/override.css">

 
<link href="https://fonts.googleapis.com/css?family=Inconsolata|Open+Sans|Roboto|Montserrat|Concert+One" rel="stylesheet">



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
				  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', '37761605', 'auto');
	  ga('send', 'pageview');

</script>


        <header>
<nav class="navbar navbar-default navbar-fixed-top navbar-inverse font-header">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" id="green-terminal" href=http://www.linuxian.com>rahulinux@web ~ $</a>
		</div>

		
		<div class="collapse navbar-collapse" id="navbar-collapse-1">
			<ul class="nav navbar-nav navbar-right">
				<li>
					<a href="http://www.linuxian.com">/home/rahulinux</a>
				</li>
				
				
				<li >
					<a href="/posts">~/posts</a>
				</li>
				
				
				<li >
					<a href="/aboute-me">~/about_me</a>
				</li>
				

			</ul>
		</div>
	</div>
</nav>
</header>

    </head>

    <body>
        <div class="container wrapper">
            <h1><a href="http://www.linuxian.com/posts/python-script-display-and-mail-users-account-expiry-details/">Send password expiry notification to nix users using Python script</a></h1>
             
            <span class="post-date">Jun 14, 2013 </span>
            
            <div class="post-content">
		
	        <div id="toc" class="well col-md-4 col-sm-6", style="float:right;" >
                 
                </div>
		
                <p>Are you Managing N Number of Users and want to check Account Expires and send notification to administrator through Gmail ?</p>

<p>Here is a Python script which will send notification to administrator, which accounts are going to expire in 7 days. You are free to use and modify this script for your work.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="color:#75715e">#---------------------------------------------------------</span>
<span style="color:#75715e"># Name          :- checkUsrAccount_Expiry.py v 0.1 Copyleft (c) :)</span>
<span style="color:#75715e"># Pupose        :- To check the user account expire status in Linux, unix, BSD etc</span>
<span style="color:#75715e"># Author        :- Rahul Patil&lt;http://www.linuxian.com&gt;</span>
<span style="color:#75715e"># Created       :- 12 Jun 2013</span>
<span style="color:#75715e"># Version       :- 0.1</span>
<span style="color:#75715e"># License       :- free</span>
<span style="color:#75715e">#---------------------------------------------------------</span>

<span style="color:#75715e"># Report `checkUsrAccount_Expiry.py` bugs to loginrahul90@gmail.com</span>

<span style="color:#f92672">import</span> re
<span style="color:#f92672">import</span> socket
<span style="color:#f92672">import</span> smtplib
<span style="color:#f92672">import</span> datetime

<span style="color:#75715e">#---------------------------------------------------------</span>
<span style="color:#75715e"># Specify Mail Login Credencial</span>
<span style="color:#75715e">#---------------------------------------------------------</span>
host_name <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>gethostname()
sender <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;your_mail_id@gmail.com&#39;</span>
password <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;yourpassword&#39;</span>
recipient <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;loginrahul90@gmail.com&#39;</span>   <span style="color:#75715e"># set admin email ID</span>
subject <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;Account Expiry Details of {!r}&#39;</span><span style="color:#f92672">.</span>format(host_name)
min_days <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>   <span style="color:#75715e"># set min days</span>

<span style="color:#75715e">#---------------------------------------------------------</span>
<span style="color:#75715e"># Specify SMTP Server</span>
<span style="color:#75715e">#---------------------------------------------------------</span>
server <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;smtp.gmail.com&#39;</span>
port <span style="color:#f92672">=</span> <span style="color:#ae81ff">587</span>


<span style="color:#75715e">#---------------------------------------------------------</span>
body1 <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;{:&lt;8s} :: {:&lt;2n} days || Last date :: {:3s}&#34;</span>
body2 <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;{:&lt;8s} :: Expired on {:3s}&#34;</span>
msg <span style="color:#f92672">=</span> []

<span style="color:#75715e">#---------------------------------------------------------</span>
<span style="color:#75715e"># Sent Mail</span>
<span style="color:#75715e">#---------------------------------------------------------</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">mailIt</span>(body):
        body <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&lt;br&gt;&#39;</span><span style="color:#f92672">.</span>join(body) <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;&#34;</span>
        headers <span style="color:#f92672">=</span> [<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;From: &#34;</span> <span style="color:#f92672">+</span> sender,
                    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Subject: &#34;</span> <span style="color:#f92672">+</span> subject,
                    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;To: &#34;</span> <span style="color:#f92672">+</span> recipient,
                    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;MIME-Version: 1.0&#34;</span>,
                    <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Content-Type: text/html&#34;</span>]
        headers <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">.</span>join(headers)
        session <span style="color:#f92672">=</span> smtplib<span style="color:#f92672">.</span>SMTP(server, port)
        session<span style="color:#f92672">.</span>ehlo()
        session<span style="color:#f92672">.</span>starttls()
        session<span style="color:#f92672">.</span>ehlo
        session<span style="color:#f92672">.</span>login(sender, password)
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">Sending Mail...&#34;</span>
        session<span style="color:#f92672">.</span>sendmail(sender, recipient, headers <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\r\n\r\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">+</span> body)
        <span style="color:#66d9ef">print</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;Sent Successfullly !!&#34;</span>
        session<span style="color:#f92672">.</span>quit()


total_expired_users <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
total_expring_users <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
expr_list <span style="color:#f92672">=</span> {}

<span style="color:#75715e">#---------------------------------------------------------</span>
<span style="color:#75715e">#  Convert Unix timestamp to Readable Date/time</span>
<span style="color:#75715e">#---------------------------------------------------------</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">convUnixTime</span>(t):
        <span style="color:#66d9ef">return</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>fromtimestamp(t<span style="color:#f92672">*</span><span style="color:#ae81ff">60</span><span style="color:#f92672">*</span><span style="color:#ae81ff">60</span><span style="color:#f92672">*</span><span style="color:#ae81ff">24</span>)


<span style="color:#75715e">#---------------------------------------------------------</span>
<span style="color:#75715e"># Read shadow file and check for account expriry</span>
<span style="color:#75715e">#---------------------------------------------------------</span>
<span style="color:#66d9ef">with</span> open( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;/etc/shadow&#34;</span> ) <span style="color:#66d9ef">as</span> shadow:
        <span style="color:#66d9ef">for</span> aLine <span style="color:#f92672">in</span> shadow:
                filed <span style="color:#f92672">=</span> aLine<span style="color:#f92672">.</span>split(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;:&#34;</span>)
                Ac <span style="color:#f92672">=</span> filed[<span style="color:#ae81ff">7</span>]
                <span style="color:#66d9ef">try</span>:
                        Ac <span style="color:#f92672">=</span> int(Ac)
                        exprdate <span style="color:#f92672">=</span> convUnixTime(Ac)
                        Ac<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#f92672">+</span>( exprdate <span style="color:#f92672">-</span> datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>today())<span style="color:#f92672">.</span>days
                        l<span style="color:#f92672">=</span>[Ac,exprdate]
                <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">ValueError</span>:
                        <span style="color:#66d9ef">pass</span>
                <span style="color:#66d9ef">else</span>:
                        <span style="color:#66d9ef">if</span> Ac <span style="color:#f92672">&lt;=</span> min_days:
                                expr_list[filed[<span style="color:#ae81ff">0</span>]]<span style="color:#f92672">=</span>l
                        <span style="color:#66d9ef">if</span> Ac <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>:
                                total_expired_users <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
                        <span style="color:#66d9ef">else</span>:
                                total_expring_users <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>

<span style="color:#75715e">#---------------------------------------------------------</span>
<span style="color:#75715e"># Check Account Expry days and format it Properly Output</span>
<span style="color:#75715e">#---------------------------------------------------------</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">AccountExprDetails</span>():
        msg <span style="color:#f92672">=</span> []
        t1 <span style="color:#f92672">=</span> total_expired_users
        t2 <span style="color:#f92672">=</span> total_expring_users
        <span style="color:#66d9ef">if</span> t1 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
                msg<span style="color:#f92672">.</span>append(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;====&gt;&gt;Following {!r} Account has been Expired&#34;</span><span style="color:#f92672">.</span>format(t1))
                index <span style="color:#f92672">=</span> t1
        <span style="color:#66d9ef">else</span>:
                index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">for</span> usr,days <span style="color:#f92672">in</span> expr_list<span style="color:#f92672">.</span>iteritems():
                dt<span style="color:#f92672">=</span>str(days[<span style="color:#ae81ff">1</span>])
                <span style="color:#66d9ef">if</span>   days[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>:
                        msg<span style="color:#f92672">.</span>insert(<span style="color:#ae81ff">1</span>,body2<span style="color:#f92672">.</span>format(usr,dt))
                <span style="color:#66d9ef">elif</span> days[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&lt;=</span> min_days:
                        msg<span style="color:#f92672">.</span>extend([body1<span style="color:#f92672">.</span>format(usr,days[<span style="color:#ae81ff">0</span>],dt)])
        <span style="color:#66d9ef">if</span> t2 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>:
                msg<span style="color:#f92672">.</span>insert(index<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>,<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;====&gt;&gt;Following {0} Account will be Expire in {1} Days&#34;</span><span style="color:#f92672">.</span>format(t2,min_days))
        <span style="color:#66d9ef">return</span> msg



msg <span style="color:#f92672">=</span> AccountExprDetails()

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;__main__&#34;</span>:
       <span style="color:#66d9ef">if</span> len(msg):
                <span style="color:#66d9ef">print</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join(msg)
                mailIt(msg)
       <span style="color:#66d9ef">else</span>:
                <span style="color:#66d9ef">print</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;No User Account has been Expire&#34;</span></code></pre></div>
<p>Sample Output:</p>

<pre><code>====&gt;&gt;Following 3 Account has been Expired
test     :: Expired on 2013-06-01 05:30:00
vinayak  :: Expired on 1970-01-01 05:30:00
ram      :: Expired on 2013-06-14 05:30:00
====&gt;&gt;Following 4 Account will be Expire in 20 Days
suraj    :: 1  days || Last date :: 2013-06-15 05:30:00
javed    :: 1  days || Last date :: 2013-06-15 05:30:00
shyam    :: 1  days || Last date :: 2013-06-15 05:30:00

Sending Mail...
Sent Successfully !!
</code></pre>

<p>You can find Updated Script from [this](&ldquo;<a href="https://github.com/rahulinux/checkUsrAccount_Expiry.py/blob/master/checkUsrAccount_Expiry.py&quot;">https://github.com/rahulinux/checkUsrAccount_Expiry.py/blob/master/checkUsrAccount_Expiry.py&quot;</a>) page</p>

<p>Have fun :-)</p>

            </div>
	    <div class="post-comments">
               
	       <button type="button" class="btn btn-default btn-lg"><a class="previous" href="http://www.linuxian.com/posts/sed-10-useful-commands/"><span class="glyphicon glyphicon-arrow-left"></span> Previous SED 10 useful commands</a></button>
               
               
	       <button type="button" class="btn btn-default btn-lg"><a class="next" href="http://www.linuxian.com/posts/hands-on-linux-commands/">Useful Linux Commands Next <span class="glyphicon glyphicon-arrow-right"></span> </a></button>
               
            </div>
	    <p></p>
            
            <div class="post-comments">
                <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "linuxian" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
            </div>
            
            <div class="push"></div>
        </div>
        <footer class="footer text-center">

<div class="text-center">Copyright © 2017 Rahul Patil</div>

</footer>

    </body>
